<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenStay | ConfiguraÃ§Ãµes</title>

    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="theme/dark.css" id="theme-style">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Sidebar dinÃ¢mica -->
    <div id="sidebar"></div>

    <main class="content">
        <header class="header">
            <button class="menu-toggle" id="header-menu-toggle">â˜°</button> <!-- BotÃ£o de menu hambÃºrguer no cabeÃ§alho -->
            <h1>âš™ï¸ ConfiguraÃ§Ãµes do Sistema</h1>
            <button id="toggle-theme">ğŸŒ“</button>
        </header>

        <section class="dashboard">
            <div class="card" style="flex: 1 1 100%;">
                <h3>âš™ï¸ PreferÃªncias do ZenStay</h3>
                <form id="formConfig">
                    <div class="form-row">
                        <div class="input-group">
                            <span>ğŸ¨</span>
                            <select id="temaPreferido">
                                <option value="dark">ğŸŒ‘ Tema Escuro</option>
                                <option value="light">â˜€ï¸ Tema Claro</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <span>ğŸŒ</span>
                            <select id="idiomaSistema">
                                <option value="pt-BR">ğŸ‡§ğŸ‡· PortuguÃªs (Brasil)</option>
                                <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                                <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <span>ğŸ’¬</span>
                            <input type="text" id="mensagemPadrao" placeholder="Mensagem padrÃ£o de boas-vindas (WhatsApp)">
                        </div>
                    </div>

                    <button type="submit" class="btn">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
                </form>
            </div>

            <div class="card" style="flex: 1 1 100%;">
                <h3>ğŸ—‚ï¸ Backup e Dados</h3>
                <div class="form-row">
                    <button id="btnExportar" class="btn">â¬‡ï¸ Exportar Dados</button>
                    <button id="btnImportar" class="btn">â¬†ï¸ Importar Dados</button>
                    <input type="file" id="inputImportar" accept=".json" style="display:none;">
                </div>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="assets/js/storage.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- Sidebar dinÃ¢mica -->
    <script>
        fetch("assets/components/sidebar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("sidebar").innerHTML = html;
                
                const currentPage = window.location.pathname.split('/').pop();
                const body = document.body;
                const sidebarElement = document.querySelector('.sidebar');
                const menuToggleButton = document.getElementById('menu-toggle'); // Menu toggle inside sidebar
                const headerMenuToggleButton = document.getElementById('header-menu-toggle'); // Menu toggle in header

                function toggleSidebar() {
                    body.classList.toggle('sidebar-open-mobile');
                }

                // Add listener for the hamburger menu button in the sidebar (if it exists)
                if (menuToggleButton) {
                    menuToggleButton.addEventListener('click', function(e) {
                        e.stopPropagation(); 
                        toggleSidebar();
                    });
                }

                // Add listener for the hamburger menu button in the header (for mobile)
                if (headerMenuToggleButton) {
                    headerMenuToggleButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleSidebar();
                    });
                }

                // Close sidebar if clicking outside of it (mobile only)
                document.addEventListener('click', function(e) {
                    if (body.classList.contains('sidebar-open-mobile') && 
                        !sidebarElement.contains(e.target) && 
                        (menuToggleButton && !menuToggleButton.contains(e.target)) && 
                        (headerMenuToggleButton && !headerMenuToggleButton.contains(e.target))) {
                        toggleSidebar();
                    }
                });

                // LÃ³gica para expandir/recolher submenus e ativar links
                document.querySelectorAll('.sidebar a').forEach(link => {
                    const href = link.getAttribute('href');
                    const parentLi = link.closest('li');

                    // Handle active state and submenu expansion
                    if (href === currentPage) {
                        link.classList.add('active');
                        const parentSubmenu = link.closest('.submenu');
                        if (parentSubmenu) {
                            parentSubmenu.style.display = 'block';
                            const parentHasSubmenu = parentSubmenu.closest('.has-submenu');
                            if (parentHasSubmenu) {
                                parentHasSubmenu.classList.add('expanded');
                            }
                        }
                        
                        // Prevent default behavior if clicking on the active non-submenu link
                        if (!parentLi.classList.contains('has-submenu')) {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                            });
                        }
                    } else {
                        link.classList.remove('active');
                    }

                    // Close sidebar on mobile when a link is clicked (unless it's a submenu-toggle)
                    link.addEventListener('click', function() {
                        if (window.innerWidth <= 768 && !this.classList.contains('submenu-toggle')) {
                            body.classList.remove('sidebar-open-mobile');
                        }
                    });
                });

                // LÃ³gica para expandir/recolher submenus
                document.querySelectorAll('.submenu-toggle').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const parentLi = this.closest('.has-submenu');
                        parentLi.classList.toggle('expanded');
                        const submenu = parentLi.querySelector('.submenu');
                        if (submenu) {
                            submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
                        }
                    });
                });
            })
            .catch(err => console.error("Erro ao carregar sidebar: ", err));
    </script>

    <!-- ConfiguraÃ§Ãµes e Backup -->
    <script>
        const formConfig = document.getElementById('formConfig');
        const temaInput = document.getElementById('temaPreferido');
        const idiomaInput = document.getElementById('idiomaSistema');
        const msgInput = document.getElementById('mensagemPadrao');
        const btnExportar = document.getElementById('btnExportar');
        const btnImportar = document.getElementById('btnImportar');
        const inputImportar = document.getElementById('inputImportar');

        //Carregar configuraÃ§Ãµes salvas
        function carregarConfiguracoes() {
            const config = JSON.parse(localStorage.getItem('configZenStay')) || {};
            if (config.temaPreferido) temaInput.value = config.temaPreferido;
            if (config.idiomaSistema) idiomaInput.value = config.idiomaSistema;
            if (config.mensagemPadrao) msgInput.value = config.mensagemPadrao;
        }

        //Salvar configuraÃ§Ãµes
        formConfig.addEventListener('submit', e => {
            e.preventDefault();
            const config = {
                temaPreferido: temaInput.value,
                idiomaSistema: idiomaInput.value,
                mensagemPadrao: msgInput.value
            };
            localStorage.setItem('configZenStay', JSON.stringify(config));
            alert('âœ… ConfiguraÃ§Ãµes salvas com sucesso!');
        });

        //Exportar dados (backup local)
        btnExportar.addEventListener('click', () => {
            const backup = {
                clientes: localStorage.getItem('clientes'),
                anfitrioes: localStorage.getItem('anfitrioes'),
                imoveis: localStorage.getItem('imoveis'),
                plataformas: localStorage.getItem('plataformas'),
                reservas: localStorage.getItem('reservas'),
                transacoes: localStorage.getItem('transacoes'),
                configuracoes: localStorage.getItem('configZenStay')
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_zenstay_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        //Importar backup
        btnImportar.addEventListener('click', () => inputImportar.click());

        inputImportar.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = evt => {
                try {
                    const data = JSON.parse(evt.target.result);
                    Object.keys(data).forEach(key => {
                        if (data[key]) localStorage.setItem(key, data[key]);
                    });
                    alert('âœ… Backup restaurado com sucesso!');
                    carregarConfiguracoes();
                } catch (error) {
                    alert('âŒ Erro ao importar arquivo: formato invÃ¡lido.');
                }
            };
            reader.readAsText(file);
        });

        window.addEventListener('DOMContentLoaded', carregarConfiguracoes);
    </script>
</body>
</html>
