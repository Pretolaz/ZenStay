<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenStay | Im√≥veis</title>

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- External CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/toast.css">
    <link rel="stylesheet" href="theme/dark.css" id="theme-style">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#0f172a',
                        surface: '#1e293b',
                    }
                }
            }
        }
    </script>

    <style>
        /* Glassmorphism & Base Styles */
        body {
            background-color: #f8fafc;
        }

        body.dark-mode {
            background-color: #020617;
            /* Slate 950 */
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            /* Slate 900 with opacity */
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .input-animated {
            transition: all 0.3s ease;
        }

        .input-animated:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.3);
        }

        .card-hoverable {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hoverable:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3B82F6;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #3B82F6;
        }

        /* Status Badges */
        .badge-Liberado {
            background: #dcfce7;
            color: #166534;
        }

        .badge-Locado {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-EmLimpeza {
            background: #fef9c3;
            color: #854d0e;
        }

        /* "Em limpeza" fallback handled in JS */
        .badge-Suspenso {
            background: #f3f4f6;
            color: #374151;
        }

        .badge-Inativo {
            background: #1e293b;
            color: #94a3b8;
        }

        body.dark-mode .badge-Liberado {
            background: #14532d;
            color: #dcfce7;
            border: 1px solid #166534;
        }

        body.dark-mode .badge-Locado {
            background: #7f1d1d;
            color: #fecaca;
            border: 1px solid #991b1b;
        }

        body.dark-mode .badge-EmLimpeza {
            background: #713f12;
            color: #fef08a;
            border: 1px solid #854d0e;
        }

        body.dark-mode .badge-Suspenso {
            background: #374151;
            color: #e5e7eb;
            border: 1px solid #4b5563;
        }

        body.dark-mode .badge-Inativo {
            background: #0f172a;
            color: #64748b;
            border: 1px solid #1e293b;
        }
    </style>
</head>

<body class="antialiased transition-colors duration-300">

    <!-- Sidebar Wrapper -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-50"></div>

    <main class="content transition-all duration-300 min-h-screen flex flex-col md:ml-[220px]">

        <!-- Header -->
        <header
            class="sticky top-0 z-40 glass-panel border-b border-gray-200/50 dark:border-gray-800/50 px-6 py-4 flex justify-between items-center mr-6 mt-6 rounded-2xl mx-4 lg:mx-8">
            <div class="flex items-center gap-4">
                <button class="menu-toggle md:hidden text-2xl text-slate-600 dark:text-slate-300"
                    id="header-menu-toggle">
                    ‚ò∞
                </button>
                <div>
                    <h1
                        class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400">
                        Im√≥veis
                    </h1>
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Gerenciamento de Propriedades
                    </p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button id="toggle-theme"
                    class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xl shadow-sm hover:shadow-md transition-all">
                    üåì
                </button>
                <button id="btnNovoImovel"
                    class="hidden sm:flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform hover:-translate-y-0.5 font-medium">
                    <span class="text-lg">+</span> Novo Im√≥vel
                </button>
            </div>
        </header>

        <!-- Mobile FAB -->
        <button id="btnNovoImovelMobile"
            class="sm:hidden fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center text-3xl z-40 hover:scale-110 transition-transform">
            +
        </button>

        <section class="p-4 lg:p-8 space-y-8 max-w-[1600px] mx-auto w-full relative">

            <!-- Filters & Search -->
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="relative w-full md:w-96">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-slate-400 text-lg">üîç</span>
                    </div>
                    <input type="text" id="filtroBusca"
                        class="pl-10 pr-4 py-3 w-full rounded-xl border-none ring-1 ring-slate-200 dark:ring-slate-700 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 shadow-sm transition-all text-slate-600 dark:text-slate-200 placeholder-slate-400"
                        placeholder="Buscar por nome, apelido, endere√ßo...">
                </div>

                <div class="flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                    <select id="filtroStatus"
                        class="px-4 py-3 rounded-xl border-none ring-1 ring-slate-200 dark:ring-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-200 focus:ring-2 focus:ring-blue-500 shadow-sm cursor-pointer outline-none">
                        <option value="">Todos os Status</option>
                        <option value="Liberado">‚úÖ Liberado</option>
                        <option value="Locado">üè† Locado</option>
                        <option value="Em limpeza">üßπ Em limpeza</option>
                        <option value="Suspenso">‚è∏Ô∏è Suspenso</option>
                        <option value="Inativo">‚õî Inativo</option>
                    </select>
                </div>
            </div>

            <!-- Grid Layout for Properties -->
            <div id="gridImoveis" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                <!-- Cards Injected Here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState"
                class="hidden flex flex-col items-center justify-center py-24 opacity-0 transition-opacity duration-500">
                <div
                    class="w-24 h-24 bg-blue-50 dark:bg-slate-800/50 rounded-full flex items-center justify-center mb-4">
                    <span class="text-4xl">üè†</span>
                </div>
                <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200">Nenhum im√≥vel encontrado</h3>
                <p class="text-slate-400">Tente ajustar seus filtros ou cadastre um novo im√≥vel.</p>
            </div>

        </section>
    </main>

    <!-- Slide-Over Modal for Create/Edit -->
    <div id="modalImovel" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop">
        </div>

        <div class="fixed inset-y-0 right-0 flex max-w-full pl-0 sm:pl-10 pointer-events-none">
            <div class="pointer-events-auto w-screen max-w-2xl transform transition ease-in-out duration-500 translate-x-full"
                id="modalPanel">
                <div class="flex h-full flex-col bg-white dark:bg-slate-900 shadow-2xl">

                    <!-- Header -->
                    <div
                        class="px-6 py-6 bg-gradient-to-r from-blue-600 to-indigo-600 flex justify-between items-center shrink-0">
                        <div>
                            <h2 class="text-xl font-semibold text-white" id="modalTitle">Novo Im√≥vel</h2>
                            <p class="text-blue-100 text-sm mt-1">Preencha os detalhes da propriedade.</p>
                        </div>
                        <button onclick="closeModal()" type="button"
                            class="rounded-full p-2 bg-white/20 hover:bg-white/30 text-white transition-colors focus:outline-none">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Body (Scrollable) -->
                    <div class="flex-1 overflow-y-auto p-6 md:p-8 space-y-8">
                        <form id="formImovel" class="space-y-8">
                            <input type="hidden" id="imovelId">

                            <!-- Image Upload Section -->
                            <div class="flex flex-col items-center gap-4">
                                <div class="relative w-full h-64 bg-slate-100 dark:bg-slate-800 rounded-2xl overflow-hidden border-2 border-dashed border-slate-300 dark:border-slate-700 flex items-center justify-center group cursor-pointer transition-colors hover:border-blue-500"
                                    onclick="document.getElementById('fotoImovel').click()">
                                    <img id="imgPreview" src=""
                                        class="absolute inset-0 w-full h-full object-cover hidden">
                                    <div class="text-center p-6 group-hover:scale-105 transition-transform"
                                        id="uploadPlaceholder">
                                        <div
                                            class="w-16 h-16 bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">
                                            üì∑
                                        </div>
                                        <p class="text-sm font-medium text-slate-600 dark:text-slate-300">Clique para
                                            adicionar foto</p>
                                        <p class="text-xs text-slate-400 mt-1">PNG, JPG at√© 5MB</p>
                                    </div>
                                    <input type="file" id="fotoImovel" accept="image/*" class="hidden"
                                        onchange="previewImage(event)">
                                </div>
                            </div>

                            <!-- Basic Info -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">C√≥digo</label>
                                    <input type="text" id="codigo" readonly
                                        class="w-full bg-slate-100 dark:bg-slate-800 border-none rounded-xl text-slate-500 text-sm p-4 font-mono"
                                        placeholder="Autom√°tico">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Apelido
                                        (Interno)</label>
                                    <input type="text" id="apelido" required
                                        class="w-full input-animated bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:text-white"
                                        placeholder="Ex: Casa Praia">
                                </div>
                            </div>

                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Nome
                                    P√∫blico</label>
                                <input type="text" id="nome" required
                                    class="w-full input-animated bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:text-white"
                                    placeholder="Ex: Mans√£o Vista Mar">
                            </div>

                            <!-- Location -->
                            <div
                                class="space-y-4 p-5 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800">
                                <h3
                                    class="text-sm font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                    üìç Localiza√ß√£o
                                </h3>
                                <div>
                                    <input type="text" id="endereco"
                                        class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none dark:text-white text-sm"
                                        placeholder="Endere√ßo completo">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">üó∫Ô∏è</span>
                                    <input type="url" id="googleMapsLink"
                                        class="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none dark:text-white text-sm"
                                        placeholder="Link do Google Maps">
                                </div>
                            </div>

                            <!-- Details -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Status</label>
                                    <select id="situacao"
                                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none dark:text-white text-sm">
                                        <option value="Liberado">Liberado</option>
                                        <option value="Locado">Locado</option>
                                        <option value="Em limpeza">Em limpeza</option>
                                        <option value="Suspenso">Suspenso</option>
                                        <option value="Inativo">Inativo</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Adultos</label>
                                    <input type="number" id="capacidadeAdulto" min="0"
                                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none dark:text-white text-sm">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Crian√ßas</label>
                                    <input type="number" id="capacidadeCrianca" min="0"
                                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none dark:text-white text-sm">
                                </div>
                            </div>

                            <!-- Pet Toggle -->
                            <div
                                class="flex items-center justify-between p-4 bg-blue-50 dark:bg-slate-800/80 rounded-xl border border-blue-100 dark:border-slate-700">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üêæ</span>
                                    <div>
                                        <p class="font-semibold text-slate-700 dark:text-white text-sm">Aceita Pets?</p>
                                        <p class="text-xs text-slate-400">Permitir animais de estima√ß√£o</p>
                                    </div>
                                </div>
                                <label for="aceitaPet" class="relative inline-block w-12 h-6 cursor-pointer">
                                    <input type="checkbox" id="aceitaPet" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
                                    </div>
                                </label>
                            </div>

                            <!-- Descriptions -->
                            <div class="space-y-4">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Descri√ß√£o</label>
                                    <textarea id="descricao" rows="3"
                                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none dark:text-white text-sm resize-none"></textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Instru√ß√µes
                                            Gerais</label>
                                        <textarea id="instrucoesGerais" rows="3"
                                            class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none dark:text-white text-sm resize-none"></textarea>
                                    </div>
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Instru√ß√µes
                                            Chegada</label>
                                        <textarea id="instrucoesChegada" rows="3"
                                            class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none dark:text-white text-sm resize-none"></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Footer -->
                    <div
                        class="border-t border-slate-200 dark:border-slate-700 px-6 py-6 bg-slate-50 dark:bg-slate-900/50 shrink-0 flex gap-3">
                        <button type="button" onclick="closeModal()"
                            class="flex-1 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm font-bold text-slate-700 dark:text-slate-300 shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">Cancelar</button>
                        <button type="button" onclick="salvarImovel(event)"
                            class="flex-1 rounded-xl bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 text-sm font-bold shadow-lg shadow-blue-500/30 transition-all transform hover:-translate-y-0.5">Salvar
                            Im√≥vel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="assets/js/storage.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/toast.js"></script>
    <script type="module" src="assets/js/entities/imovel.js"></script>

    <script type="module">
        import { Imovel } from './assets/js/entities/imovel.js';

        let imoveisCache = [];
        let currentPhotoBase64 = null;

        // UI Refs
        const grid = document.getElementById('gridImoveis');
        const emptyState = document.getElementById('emptyState');
        const modal = document.getElementById('modalImovel');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalPanel = document.getElementById('modalPanel');
        const form = document.getElementById('formImovel');

        // Init
        window.addEventListener('DOMContentLoaded', async () => {
            await carregarImoveis();

            // Sidebar Logic
            fetch("assets/components/sidebar.html")
                .then(res => res.text())
                .then(html => {
                    const sb = document.getElementById('sidebar');
                    if (sb) {
                        sb.innerHTML = html;
                        setupSidebarLogic();
                    }
                });
        });

        // Event Listeners
        document.getElementById('filtroBusca').addEventListener('input', renderGrid);
        document.getElementById('filtroStatus').addEventListener('change', renderGrid);
        document.getElementById('btnNovoImovel').onclick = () => openModal();
        document.getElementById('btnNovoImovelMobile').onclick = () => openModal();

        window.previewImage = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    currentPhotoBase64 = e.target.result;
                    const img = document.getElementById('imgPreview');
                    const ph = document.getElementById('uploadPlaceholder');
                    img.src = currentPhotoBase64;
                    img.classList.remove('hidden');
                    ph.classList.add('opacity-0');
                }
                reader.readAsDataURL(file);
            }
        };

        async function carregarImoveis() {
            grid.innerHTML = '<div class="col-span-full text-center py-12"><div class="animate-spin text-4xl text-blue-500">üåÄ</div></div>';
            try {
                imoveisCache = await Imovel.listarTodos();
                renderGrid();
            } catch (err) {
                console.error(err);
                if (window.Toast) window.Toast.error("Erro ao carregar im√≥veis");
            }
        }

        window.renderGrid = () => {
            const termo = document.getElementById('filtroBusca').value.toLowerCase();
            const statusFiltro = document.getElementById('filtroStatus').value;

            const filtrados = imoveisCache.filter(imovel => {
                const matchTermo =
                    (imovel.nome && imovel.nome.toLowerCase().includes(termo)) ||
                    (imovel.titulo && imovel.titulo.toLowerCase().includes(termo)) || // apelido
                    (imovel.endereco && imovel.endereco.toLowerCase().includes(termo));

                const matchStatus = !statusFiltro || imovel.status === statusFiltro;

                return matchTermo && matchStatus;
            });

            grid.innerHTML = '';

            if (filtrados.length === 0) {
                if (imoveisCache.length === 0) {
                    // Really empty
                } else {
                    // Filter empty
                }
                emptyState.classList.remove('hidden');
                setTimeout(() => emptyState.classList.remove('opacity-0'), 10);
                return;
            }
            emptyState.classList.add('hidden');
            emptyState.classList.add('opacity-0');

            filtrados.forEach(im => {
                const fotoSrc = (im.fotos && im.fotos.length > 0) ? im.fotos[0] : 'assets/img/imovel-placeholder.png'; // Fallback
                const statusClass = `badge-${im.status ? im.status.replace(' ', '') : 'Indefinido'}`;

                const card = document.createElement('div');
                card.className = 'glass-panel rounded-2xl overflow-hidden card-hoverable flex flex-col group h-full relative border border-white/40 dark:border-slate-700/50 bg-white/60 dark:bg-slate-900/60';

                card.innerHTML = `
                    <div class="relative h-48 overflow-hidden">
                        <img src="${fotoSrc}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" onerror="this.src='https://placehold.co/600x400?text=Sem+Foto'">
                        <div class="absolute top-3 right-3 px-3 py-1 rounded-full text-xs font-bold shadow-sm uppercase tracking-wide ${statusClass}">
                            ${im.status || 'Indefinido'}
                        </div>
                        <div class="absolute bottom-0 inset-x-0 h-16 bg-gradient-to-t from-black/60 to-transparent"></div>
                        <div class="absolute bottom-3 left-4 text-white font-bold drop-shadow-md">
                            ${im.titulo || '#' + im.id}
                        </div>
                    </div>

                    <div class="p-5 flex-1 flex flex-col gap-3">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white leading-tight mb-1">${im.nome}</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 flex items-start gap-1">
                                <span class="mt-0.5">üìç</span> <span class="line-clamp-2">${im.endereco || 'Sem endere√ßo'}</span>
                            </p>
                        </div>

                        <div class="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400 mt-2">
                            <div class="flex items-center gap-1" title="Adultos">
                                <span>üë•</span> <b>${im.capacidadeAdulto || 0}</b>
                            </div>
                            <div class="flex items-center gap-1" title="Crian√ßas">
                                <span>üß∏</span> <b>${im.capacidadeCrianca || 0}</b>
                            </div>
                            ${im.aceitaPet ? '<div class="flex items-center gap-1 text-green-600 dark:text-green-400" title="Aceita Pet"><span>üêæ</span> Sim</div>' : '<div class="flex items-center gap-1 text-slate-400" title="N√£o aceita Pet"><span>üö´</span> N√£o</div>'}
                        </div>
                        
                        <div class="mt-auto pt-4 flex items-center justify-between border-t border-slate-100 dark:border-slate-700/50">
                             <a href="comodos.html" class="text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 flex items-center gap-1 hover:underline">
                                üö™ C√¥modos
                             </a>
                             <div class="flex gap-2">
                                <button onclick="window.editarImovel('${im.id}')" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-orange-50 dark:hover:bg-orange-900/30 text-slate-400 hover:text-orange-500 dark:hover:text-orange-400 transition-colors" title="Editar">‚úèÔ∏è</button>
                                <button onclick="window.excluirImovel('${im.id}')" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-red-50 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 dark:hover:text-red-400 transition-colors" title="Excluir">üóëÔ∏è</button>
                             </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        };

        // Modal Actions
        window.openModal = (imovel = null) => {
            const title = document.getElementById('modalTitle');
            const placeholder = document.getElementById('uploadPlaceholder');
            const imgPreview = document.getElementById('imgPreview');

            // Allow clicking to get to comodos.html properly if needed, but here we just manage properties

            if (imovel) {
                title.innerText = 'Editar Im√≥vel';
                document.getElementById('imovelId').value = imovel.id;
                document.getElementById('codigo').value = imovel.codigoInterno || imovel.id;
                document.getElementById('apelido').value = imovel.titulo || '';
                document.getElementById('nome').value = imovel.nome || '';
                document.getElementById('endereco').value = imovel.endereco || '';
                document.getElementById('googleMapsLink').value = imovel.googleMapsLink || '';
                document.getElementById('situacao').value = imovel.status || 'Liberado';
                document.getElementById('capacidadeAdulto').value = imovel.capacidadeAdulto || 0;
                document.getElementById('capacidadeCrianca').value = imovel.capacidadeCrianca || 0;
                document.getElementById('aceitaPet').checked = !!imovel.aceitaPet;
                document.getElementById('descricao').value = imovel.descricao || '';
                document.getElementById('instrucoesGerais').value = imovel.instrucoesGerais || '';
                document.getElementById('instrucoesChegada').value = imovel.instrucoesChegada || '';

                if (imovel.fotos && imovel.fotos.length > 0) {
                    currentPhotoBase64 = imovel.fotos[0];
                    imgPreview.src = currentPhotoBase64;
                    imgPreview.classList.remove('hidden');
                    placeholder.classList.add('opacity-0');
                } else {
                    currentPhotoBase64 = null;
                    imgPreview.classList.add('hidden');
                    placeholder.classList.remove('opacity-0');
                }
            } else {
                title.innerText = 'Novo Im√≥vel';
                form.reset();
                document.getElementById('imovelId').value = '';
                document.getElementById('codigo').value = '';
                document.getElementById('situacao').value = 'Liberado';
                currentPhotoBase64 = null;
                imgPreview.classList.add('hidden');
                placeholder.classList.remove('opacity-0');
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modalPanel.classList.remove('translate-x-full');
            }, 10);
        };

        window.closeModal = () => {
            modalBackdrop.classList.add('opacity-0');
            modalPanel.classList.add('translate-x-full');
            setTimeout(() => modal.classList.add('hidden'), 500);
        };

        window.editarImovel = (id) => {
            const im = imoveisCache.find(i => i.id == id);
            if (im) openModal(im);
        };

        window.excluirImovel = async (id) => {
            if (confirm('Tem certeza que deseja excluir este im√≥vel?')) {
                try {
                    await Imovel.excluir(id);
                    if (window.Toast) window.Toast.success('Im√≥vel exclu√≠do!');
                    await carregarImoveis();
                } catch (e) { console.error(e); }
            }
        };

        window.salvarImovel = async (e) => {
            e.preventDefault();
            const btn = e.target;
            const originalText = btn.innerText;
            btn.innerText = 'Salvando...';
            btn.disabled = true;

            try {
                const id = document.getElementById('imovelId').value;

                // Construct Data
                const data = {
                    codigoInterno: id ? parseInt(document.getElementById('codigo').value) : null,
                    titulo: document.getElementById('apelido').value,
                    nome: document.getElementById('nome').value,
                    endereco: document.getElementById('endereco').value,
                    googleMapsLink: document.getElementById('googleMapsLink').value,
                    status: document.getElementById('situacao').value,
                    capacidadeAdulto: parseInt(document.getElementById('capacidadeAdulto').value) || 0,
                    capacidadeCrianca: parseInt(document.getElementById('capacidadeCrianca').value) || 0,
                    aceitaPet: document.getElementById('aceitaPet').checked,
                    descricao: document.getElementById('descricao').value,
                    instrucoesGerais: document.getElementById('instrucoesGerais').value,
                    instrucoesChegada: document.getElementById('instrucoesChegada').value,
                    fotos: []
                };

                // Handle Photo
                if (currentPhotoBase64) {
                    data.fotos = [currentPhotoBase64]; // Replacing array for simplicity as per current logic
                } else if (id) {
                    // Keep existing if not changed? The logic above resets currentPhotoBase64 on openModal unless edit.
                    // checks cache
                    const existing = imoveisCache.find(i => i.id == id);
                    if (existing && existing.fotos) data.fotos = existing.fotos;
                }

                // If editing, we need the firestore ID
                if (id) {
                    const existing = imoveisCache.find(i => i.id == id);
                    if (existing) data.firestoreId = existing.firestoreId;
                    data.id = parseInt(id);
                }

                await Imovel.salvar(data);
                if (window.Toast) window.Toast.success('Im√≥vel salvo com sucesso!');
                closeModal();
                await carregarImoveis();

            } catch (err) {
                console.error(err);
                if (window.Toast) window.Toast.error("Erro ao salvar: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // Load sidebar logic tailored for sticky positioning and content push
        function setupSidebarLogic() {
            const btn = document.getElementById('header-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const body = document.body;

            // Toggle sidebar for mobile
            if (btn) {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    body.classList.toggle('sidebar-open-mobile');
                };
            }

            // Highlight Link
            const currentPage = 'imoveis.html'; // Hardcoded for this file
            const links = sidebar.querySelectorAll('a');
            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href && href.includes('imoveis.html')) {
                    link.classList.add('active');

                    // Expand Submenu if usually collapsed
                    const sub = link.closest('.submenu');
                    if (sub) {
                        sub.style.display = 'block';
                        const p = sub.closest('.has-submenu');
                        if (p) {
                            p.classList.add('expanded');
                            const arrow = p.querySelector('.arrow');
                            if (arrow) arrow.style.transform = 'rotate(90deg)';
                        }
                    }
                }
            });

            // Submenu Toggles
            sidebar.querySelectorAll('.submenu-toggle').forEach(t => {
                t.onclick = (e) => {
                    e.preventDefault();
                    const li = t.closest('.has-submenu');
                    const sub = li.querySelector('.submenu');
                    const arrow = li.querySelector('.arrow');

                    if (sub) {
                        const hidden = window.getComputedStyle(sub).display === 'none';
                        sub.style.display = hidden ? 'block' : 'none';
                        if (hidden) {
                            li.classList.add('expanded');
                            if (arrow) arrow.style.transform = 'rotate(90deg)';
                        } else {
                            li.classList.remove('expanded');
                            if (arrow) arrow.style.transform = 'rotate(0deg)';
                        }
                    }
                }
            });
        }

    </script>
</body>

</html>