<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenStay | Clientes</title>

    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/clientes.css">
    <link rel="stylesheet" href="theme/dark.css" id="theme-style">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Sidebar dinÃ¢mica -->
    <div id="sidebar"></div>

    <main class="content">
        <header class="header">
            <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Gerenciar HÃ³spedes</h1>
            <button id="toggle-theme">ğŸŒ“</button>
        </header>

        <section class="dashboard">
            <!-- BotÃ£o para Cadastrar Novo HÃ³spede -->
            <div class="card" style="flex: 1 1 100%; text-align: right;">
                <button id="btnToggleForm" class="btn">â• Criar Novo HÃ³spede</button>
            </div>

            <!-- FormulÃ¡rio (inicialmente oculto) -->
            <div id="cadastroClienteCard" class="card" style="flex: 1 1 100%; display: none;">
                <h3>ğŸ“ Cadastrar Novo HÃ³spede</h3>
                <div id="alerta" class="alerta-erro"></div>

                <form id="formCliente">
                    <input type="hidden" id="clienteId">

                    <div class="form-row">
                        <div class="input-group">
                            <span>#</span>
                            <input type="number" id="codigoInterno" placeholder="CÃ³digo interno (auto)" readonly>
                        </div>
                        <div class="input-group">
                            <span>ğŸ†”</span>
                            <input type="text" id="codigoPlataforma" maxlength="20" placeholder="CÃ³digo na plataforma">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <span>ğŸ‘¤</span>
                            <input type="text" id="nome" placeholder="Nome completo" required>
                        </div>
                        <div class="input-group">
                            <span>âœ‰ï¸</span>
                            <input type="email" id="email" placeholder="E-mail (opcional)">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group" style="max-width: 220px;">
                            <span>ğŸ“</span>
                            <input type="number" id="codPais" placeholder="55" value="55" min="1">
                        </div>
                        <div class="flag-display" id="flagInfo">
                            <img src="https://flagcdn.com/w20/br.png" alt="BR">
                            <span>Brasil</span>
                        </div>
                        <div class="input-group" style="flex: 2;">
                            <span>ğŸ“±</span>
                            <input type="text" id="telefone" placeholder="NÃºmero com DDD" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <span>ğŸ”—</span>
                            <input type="url" id="linkChat" placeholder="Link do chat (opcional)">
                        </div>
                        <div class="input-group">
                            <span>ğŸ—£ï¸</span>
                            <select id="idioma">
                                <option value="pt-BR" selected>ğŸ‡§ğŸ‡· PortuguÃªs (BR)</option>
                                <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                                <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                                <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                                <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <textarea id="observacao" placeholder="ObservaÃ§Ãµes sobre o hÃ³spede..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <span>ğŸ“…</span>
                            <input type="text" id="dataCadastro" placeholder="Data de Cadastro (automÃ¡tico)" readonly>
                        </div>
                    </div>

                    <button type="submit" class="btn">ğŸ’¾ Salvar</button>
                    <button type="button" class="btn btn-secondary" id="btnCancelarCadastro">âŒ Cancelar</button>
                </form>
            </div>

            <!-- Tabela -->
            <div class="card" style="flex: 1 1 100%;">
                <h3>ğŸ“‹ Lista de HÃ³spedes</h3>
                <div class="form-row" style="margin-bottom: 15px;">
                    <div class="input-group">
                        <span>ğŸ”</span>
                        <input type="text" id="filtroNome" placeholder="Filtrar por nome...">
                    </div>
                    <div class="input-group" style="margin-left: 10px;">
                        <span>ğŸ“±</span>
                        <input type="text" id="filtroTelefone" placeholder="Filtrar por telefone...">
                    </div>
                </div>
                <table id="tabelaClientes">
                    <thead>
                        <tr>
                            <th>PaÃ­s</th>
                            <th>CÃ³d. Interno</th>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Whats App</th>
                            <th>Idioma</th>
                            <th>Data Cadastro</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="assets/js/storage.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- Sidebar dinÃ¢mica -->
    <script>
        fetch("assets/components/sidebar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("sidebar").innerHTML = html;
                
                const currentPage = window.location.pathname.split('/').pop();

                // LÃ³gica para expandir/recolher submenus e ativar links
                document.querySelectorAll('.sidebar a').forEach(link => {
                    const href = link.getAttribute('href');
                    const parentLi = link.closest('li');

                    // Handle active state and submenu expansion
                    if (href === currentPage) {
                        link.classList.add('active');
                        const parentSubmenu = link.closest('.submenu');
                        if (parentSubmenu) {
                            parentSubmenu.style.display = 'block';
                            const parentHasSubmenu = parentSubmenu.closest('.has-submenu');
                            if (parentHasSubmenu) {
                                parentHasSubmenu.classList.add('expanded');
                            }
                        }
                        
                        // Prevent default behavior if clicking on the active non-submenu link
                        if (!parentLi.classList.contains('has-submenu')) {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                            });
                        }
                    } else {
                        link.classList.remove('active');
                    }
                });

                // LÃ³gica para expandir/recolher submenus
                document.querySelectorAll('.submenu-toggle').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const parentLi = this.closest('.has-submenu');
                        parentLi.classList.toggle('expanded');
                        const submenu = parentLi.querySelector('.submenu');
                        if (submenu) {
                            submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
                        }
                    });
                });
            })
            .catch(err => console.error("Erro ao carregar sidebar: ", err));
    </script>

    <!-- CRUD de HÃ³spedes -->
    <script>
        const tabela = document.querySelector('#tabelaClientes tbody');
        const form = document.getElementById('formCliente');
        const alerta = document.getElementById('alerta');
        const campos = ['codigoInterno', 'codigoPlataforma', 'nome', 'email', 'codPais', 'telefone', 'linkChat', 'idioma', 'observacao', 'dataCadastro'];
        const flagInfo = document.getElementById('flagInfo');
        const codPaisInput = document.getElementById('codPais');
        const cadastroClienteCard = document.getElementById('cadastroClienteCard');
        const btnToggleForm = document.getElementById('btnToggleForm');
        const btnCancelarCadastro = document.getElementById('btnCancelarCadastro');
        const filtroNomeInput = document.getElementById('filtroNome');
        const filtroTelefoneInput = document.getElementById('filtroTelefone');

        let countriesList = [];

        fetch('assets/data/countries.json')
            .then(res => res.json())
            .then(data => {
                countriesList = data;
                atualizarBandeira(55);
            })
            .catch(err => console.error('Erro ao carregar countries.json: ', err));

        function atualizarBandeira(cod) {
            const pais = countriesList.find(p => String(p.dial) === String(cod));
            if (pais) {
                flagInfo.innerHTML = `
                    <img src="https://flagcdn.com/w20/${pais.code}.png" alt="${pais.name}">
                    <span>${pais.name}</span>
                `;
            } else {
                flagInfo.innerHTML = `<span>ğŸ¤· PaÃ­s nÃ£o encontrado</span>`;
            }
        }

        codPaisInput.addEventListener('input', e => atualizarBandeira(e.target.value));

        function formatarData(dataString) {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
            return new Date(dataString).toLocaleString('pt-BR', options);
        }

        function carregarClientes() {
            const clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            tabela.innerHTML = '';

            const filtroNome = filtroNomeInput.value.toLowerCase();
            const filtroTelefone = filtroTelefoneInput.value.toLowerCase();

            const clientesFiltrados = clientes.filter(cli => {
                const nomeCorresponde = cli.nome.toLowerCase().includes(filtroNome);
                const telefoneCorresponde = cli.telefone.toLowerCase().includes(filtroTelefone) || cli.codPais.toLowerCase().includes(filtroTelefone);
                return nomeCorresponde && telefoneCorresponde;
            });

            clientesFiltrados.forEach((cli, index) => {
                const pais = countriesList.find(p => String(p.dial) === String(cli.codPais));
                const bandeira = pais ? `<img src="https://flagcdn.com/w20/${pais.code}.png" alt="${pais.name}">` : 'ğŸ¤·';
                const linkWhats = `https://wa.me/${cli.codPais}${cli.telefone}`;
                const iconWhats = `
                    <a href="${linkWhats}" target="_blank" class="whatsapp-icon" title="Conversar no WhatsApp">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                            <path d="M16.04 2.003a13.89 13.89 0 0 0-11.823 21.43L2 30l6.72-2.177A13.89 13.89 0 1 0 16.04 2.003zm.01 25.12a11.27 11.27 0 0 1-5.74-1.59l-.41-.25-3.99 1.3 1.31-3.88-.27-.4a11.27 11.27 0 1 1 9.1 4.82zm6.25-8.46c-.34-.17-2.04-1.01-2.36-1.12-.32-.12-.55-.17-.78.17s-.89 1.12-1.09 1.35c-.2.22-.4.25-.74.08s-1.43-.52-2.73-1.67a10.12 10.12 0 0 1-1.86-2.32c-.2-.34 0-.52.15-.69.15-.17.34-.43.52-.65.17-.22.23-.37.34-.62.11-.25.06-.47-.03-.65-.09-.17-.78-1.88-1.07-2.56-.28-.68-.57-.58-.78-.59h-.66a1.28 1.28 0 0 0-.93.43c-.32.35-1.22 1.19-1.22 2.9s1.25 3.37 1.43 3.61c.18.25 2.45 3.74 5.93 5.25.83.36 1.48.57 1.98.73.83.27 1.59.23 2.19.14.67-.1 2.04-.83 2.33-1.63.29-.8.29-1.49.2-1.63-.09-.14-.31-.22-.65-.39z" />
                        </svg>
                    </a>`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="td-country">${bandeira}</td>
                    <td>${cli.codigoInterno}</td>
                    <td>${cli.nome}</td>
                    <td>${cli.email || '-'}</td>
                    <td>+${cli.codPais} ${cli.telefone} ${iconWhats}</td>
                    <td>${cli.idioma}</td>
                    <td>${cli.dataCadastro ? formatarData(cli.dataCadastro) : '-'}</td>
                    <td>
                        <button class="action-btn" onclick="editarCliente(${index})" title="Editar">âœï¸</button>
                        <button class="action-btn" onclick="excluirCliente(${index})" title="Excluir">ğŸ—‘ï¸</button>
                    </td>`;
                tabela.appendChild(row);
            });
        }

        function mostrarAlerta(msg) {
            alerta.style.display = 'block';
            alerta.textContent = msg;
            setTimeout(() => alerta.style.display = 'none', 4000);
        }

        function salvarCliente(e) {
            e.preventDefault();
            const clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            const cliente = {};
            campos.forEach(c => cliente[c] = document.getElementById(c).value);

            const isEditing = document.getElementById('clienteId').value;

            // Se for um novo cliente, defina a data de cadastro
            if (!isEditing) {
                cliente.dataCadastro = new Date().toISOString();
            } else {
                // Ao editar, mantenha a data de cadastro existente
                const originalCliente = clientes[isEditing];
                cliente.dataCadastro = originalCliente.dataCadastro;
            }

            const duplicadoTel = clientes.find((c, idx) => idx != isEditing && c.telefone === cliente.telefone && c.codPais === cliente.codPais);
            const duplicadoPlataforma = cliente.codigoPlataforma && clientes.find((c, idx) => idx != isEditing && c.codigoPlataforma === cliente.codigoPlataforma);

            if (!isEditing) {
                if (duplicadoTel) {
                    mostrarAlerta(`âš ï¸ O telefone +${cliente.codPais} ${cliente.telefone} jÃ¡ estÃ¡ cadastrado (CÃ³d interno: ${duplicadoTel.codigoInterno}).`);
                    return;
                }
                if (duplicadoPlataforma) {
                    mostrarAlerta(`âš ï¸ O cÃ³digo de plataforma "${cliente.codigoPlataforma}" jÃ¡ estÃ¡ cadastrado (CÃ³d interno: ${duplicadoPlataforma.codigoInterno}).`);
                    return;
                }
            }


            if (!cliente.codigoInterno) {
                const lastCode = clientes.length ? Math.max(...clientes.map(c => Number(c.codigoInterno) || 0)) : 1000;
                cliente.codigoInterno = Number(lastCode) + 1;
            }

            if (isEditing) clientes[isEditing] = cliente;
            else clientes.push(cliente);

            localStorage.setItem('clientes', JSON.stringify(clientes));
            form.reset();
            document.getElementById('codigoInterno').value = '';
            document.getElementById('codPais').value = 55;
            atualizarBandeira(55);
            document.getElementById('clienteId').value = '';
            document.getElementById('dataCadastro').value = ''; // Limpa o campo de data de cadastro
            carregarClientes();
            toggleFormVisibility(); // Esconde o formulÃ¡rio apÃ³s salvar
        }

        function editarCliente(index) {
            const clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            const cli = clientes[index];
            campos.forEach(c => document.getElementById(c).value = cli[c] || '');
            atualizarBandeira(cli.codPais);
            document.getElementById('clienteId').value = index;
            document.getElementById('dataCadastro').value = cli.dataCadastro ? formatarData(cli.dataCadastro) : ''; // Exibe a data de cadastro
            cadastroClienteCard.style.display = 'block'; // Mostra o formulÃ¡rio para ediÃ§Ã£o
            btnToggleForm.textContent = 'âœ–ï¸ Fechar FormulÃ¡rio';
            window.scrollTo(0, 0); // Rola para o topo para mostrar o formulÃ¡rio
        }

        function excluirCliente(index) {
            if (confirm('Excluir este hÃ³spede?')) {
                const clientes = JSON.parse(localStorage.getItem('clientes')) || [];
                clientes.splice(index, 1);
                localStorage.setItem('clientes', JSON.stringify(clientes));
                carregarClientes();
            }
        }

        function toggleFormVisibility() {
            if (cadastroClienteCard.style.display === 'none') {
                cadastroClienteCard.style.display = 'block';
                btnToggleForm.textContent = 'âœ–ï¸ Fechar FormulÃ¡rio';
                form.reset(); // Limpa o formulÃ¡rio ao abrir para um novo cadastro
                document.getElementById('clienteId').value = ''; // Garante que nÃ£o estÃ¡ em modo de ediÃ§Ã£o
                document.getElementById('codigoInterno').value = '';
                document.getElementById('codPais').value = 55;
                atualizarBandeira(55);
                document.getElementById('dataCadastro').value = '';
            } else {
                cadastroClienteCard.style.display = 'none';
                btnToggleForm.textContent = 'â• Criar Novo HÃ³spede';
                form.reset(); // Limpa o formulÃ¡rio ao fechar
                document.getElementById('clienteId').value = ''; // Garante que nÃ£o estÃ¡ em modo de ediÃ§Ã£o
                document.getElementById('codigoInterno').value = '';
                document.getElementById('codPais').value = 55;
                atualizarBandeira(55);
                document.getElementById('dataCadastro').value = '';
            }
        }

        form.addEventListener('submit', salvarCliente);
        btnToggleForm.addEventListener('click', toggleFormVisibility);
        btnCancelarCadastro.addEventListener('click', toggleFormVisibility);
        filtroNomeInput.addEventListener('input', carregarClientes);
        filtroTelefoneInput.addEventListener('input', carregarClientes);
        window.addEventListener('DOMContentLoaded', carregarClientes);
    </script>
</body>
</html>